!function(t){function e(e,i){this._input=e,this.$input=t(e),this.options=i,this.currentTag=0,this.defaultCssClasses={input:"typeahead",hint:"typeahead"},i.alwaysVisible&&(this.defaultCssClasses.menu="tt-menu always-visible"),this.defaultTagOptions={tokenizer_key:"tt_text",min_length:0,max_limit:100,display_limit:100,value_key:"tt_value",display_key:"tt_text",suggestion_render_type:"list",custom_classes:{},input_heading:"Select",load_more_btn:!1,load_more_btn_clicked:!1,log:!1},this.init()}function i(){return!!/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent)}e.prototype.defaults={value_key:"tt_value",display_key:"tt_text",alwaysVisible:!1,disableMobileKeyboard:!1},e.prototype.init=function(){this.config=t.extend(this.defaults,this.options);var e=this.defaultTagOptions,i=t.map(this.config.tagsOptions,function(i){return t.extend({},e,i)});return this.config.tagsOptions=i,this.$input.tagsinput({itemValue:this.config.value_key,itemText:this.config.display_key,maxTags:this.maxTags,freeInput:!1,allowDuplicates:!1}),this.$input.tagsinput("input").on("typeahead:selected",function(t,e){var i=this.getCurrentOptions();e.tt_text||(e.tt_text=e[i.display_key]),e.tt_value||(e.tt_value=e[i.value_key]),this.$input.tagsinput("add",e)}.bind(this)).on("keydown",function(t){if(32===t.keyCode);else if(37===t.keyCode)return!1}.bind(this)).on("typeahead:render",function(){t(".tt-suggestion.tt-selectable").first().addClass("tt-cursor"),t("#car_input_load_more").on("click",function(t){var e=this.getCurrentOptions();e.load_more_btn=!1,e.display_limit=e.max_limit,this.initializeInput()}.bind(this)),this.$input.trigger("car_input_typeahead:rendered")}.bind(this)),this.$input.on("itemAdded",this.onTagAdded.bind(this)).on("itemRemoved",this.onTagRemoved.bind(this)),this.allocateDataSource(),this},e.prototype.onTagAdded=function(t){this.config.onTagAdded&&this.config.onTagAdded(this.getCurrentOptions(),t.item),void 0===t.item.__backindex&&(t.item.__backindex=this.currentTag),this.currentTag+=1,this.currentTag<this.config.tagsOptions.length?this.initializeInput():this.finalize()},e.prototype.finalize=function(){this.$input.tagsinput("input").typeahead("destroy"),this.updateInputHelpText(""),t(".twitter-typeahead .typeahead").attr("readonly",!0),this.config.complete.apply(null,this.getCurrentTagItems())},e.prototype.onTagRemoved=function(t){this.currentTag=t.item.__backindex;var e=this.getCurrentTagItems();this.$input.off("itemRemoved");for(var i=e.length-1;i>=this.currentTag;i--)this.$input.tagsinput("remove",e[i]);this.$input.on("itemRemoved",this.onTagRemoved.bind(this)),this.initializeInput()},e.prototype.initializeInput=function(){this.$input.tagsinput("input").typeahead("destroy"),this.allocateDataSource()},e.prototype.updateInputHelpText=function(t){this.$input.tagsinput("input").attr("placeholder",t)},e.prototype.allocateDataSource=function(){var e,n=this.getCurrentOptions();this.updateInputHelpText(n.placeholder),e="function"==typeof n.data_source?n.data_source.apply(null,this.getCurrentTagItems()):n.data_source;var a;if("string"==typeof e){var s={datumTokenizer:Bloodhound.tokenizers.obj.whitespace(n.tokenizer_key),queryTokenizer:Bloodhound.tokenizers.whitespace,identify:function(t){return t[n.tokenizer_key]}};void 0===n.wildcard_param?s.prefetch={url:e,transform:n.data_transform}:s.remote={url:e,wildcard:n.wildcard_param,transform:n.data_transform};var o=new Bloodhound(s);a=void 0===n.wildcard_param?function(t,e){""===t?e(o.all()):o.search(t,e)}:o}else{if(1==e.length)return e[0].__backindex=this.currentTag-1,void this.$input.tagsinput("add",e[0]);a=function(i,a){var s=[],o=new RegExp(i,"i");t.each(e,function(t,e){o.test(e[n.tokenizer_key])&&s.push(e)}),a(s)}}this.$input.tagsinput("input").typeahead({hint:!0,minLength:n.min_length,highlight:!0,classNames:t.extend({},this.defaultCssClasses,n.custom_classes)},{limit:n.display_limit,name:n.data_holder_name,displayKey:function(t){return t[n.display_key]},templates:this.getTemplates(n),source:a}),this.setFocusTriggers(),i()&&this.config.disableMobileKeyboard&&t(".twitter-typeahead .typeahead").attr("readonly",!0),this.config.autoFocus&&this.$input.tagsinput("focus")},e.prototype.getTemplates=function(e){var i={empty:function(){return e.ShowMoreBtnClicked&&(this.getItemForEmptyResult(this.tagState)||this.isFound)?"":'<div class="empty-message">No match found</div>'}.bind(this),header:function(){var t=this.$input.closest("div").find(".tag-label");t.length>0?t.html("<span>"+e.input_heading+"</span>"):this.$input.closest("div").find(".tt-menu").prepend('<div class="tag-label"><span>'+e.input_heading+"</span></div>")}.bind(this),footer:function(){return e.load_more_btn?'<a class="btn-load" id="car_input_load_more" href="javascript:void(0)">Load more</a>':""}.bind(this)};return t.extend(e.templates,i)},e.prototype.setFocusTriggers=function(){t(".twitter-typeahead .typeahead").on("focus",function(e){t(e.currentTarget).closest(".bootstrap-tagsinput").addClass("active"),this.$input.trigger("car_input_typeahead:focused")}.bind(this)).on("blur",function(e){t(this).closest(".bootstrap-tagsinput").removeClass("active")})},e.prototype.getCurrentOptions=function(){return this.config.tagsOptions[this.currentTag]},e.prototype.getCurrentTagItems=function(){return this.$input.tagsinput("items")},t.fn.multiTagDrilldownInput=function(i){return this.each(function(){t.data(this,"plugin")||t.data(this,"plugin",new e(this,i))})},t.fn.multiTagDrilldownInput.defaults={}}(jQuery);